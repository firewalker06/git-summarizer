#!/usr/bin/env ruby

require "json"
require "net/http"
require "uri"
require "open3"

def default_base_branch
  origin_head = `git rev-parse --abbrev-ref origin/HEAD 2>/dev/null`.strip
  return origin_head.sub("origin/", "") if origin_head.start_with?("origin/")

  return "main" if system("git show-ref --verify --quiet refs/heads/main")
  return "master" if system("git show-ref --verify --quiet refs/heads/master")

  "main"
end

staged_diff = `git diff --cached`
has_staged_changes = !`git diff --cached --name-only`.strip.empty?
base_branch = default_base_branch
diff = if has_staged_changes
  staged_diff
else
  stdout, status = Open3.capture2("git", "diff", "#{base_branch}..HEAD")
  raise "git diff failed: #{status.exitstatus}" unless status.success?
  stdout
end

prompt = if has_staged_changes
  <<~PROMPT
    Instruction:
      - Write a commit message summarizing the change in ‚â§ 80 characters.
      - Optionally add a short description if more explanation is needed.
      - Do not include labels like "Commit Message" or "Description".
      - Output is strict: line 1 is the commit message; if present, line 2 is the description, with no blank lines.
  PROMPT
else
  <<~PROMPT
    Instruction:
      - Write a Pull Request description using the Template below.
      - Output in Markdown format.
    Template:
    ## What
    Briefly describe what changes this pull request introduces.
    ## Why
    Explain why this pull request is necessary, clearly and concisely.
    ## How
    List how the changes were implemented, using short bullet points.
  PROMPT
end

def wrap_in_color(text, color="success")
  color_mapping = {
    "failure" => 31,
    "success" => 32,
  }
  "\e[#{color_mapping[color]}m#{text}\e[0m"
end

def load_env_value(key, env_path = File.expand_path(".env", __dir__))
  env_value = ENV[key]
  return env_value unless env_value.nil? || env_value.empty?

  return nil unless File.exist?(env_path)

  File.foreach(env_path) do |line|
    stripped = line.strip
    next if stripped.empty? || stripped.start_with?("#")
    k, value = stripped.split("=", 2)
    next unless k && value
    return value.gsub(/\A['"]|['"]\z/, "") if k.strip == key
  end

  nil
end

def copy_to_clipboard(text)
  IO.popen("pbcopy", "w") { |f| f << text }
end

def consent_granted?(approval_flag)
  return true if approval_flag == "1"

  print "ü§ñ Do you have necessary consent for this code? [y/N]: "
  STDOUT.flush
  answer = STDIN.gets
  answer && answer.strip.casecmp("y").zero?
end

def fetch_ai_summary(secret_key, prompt, diff)
  uri = URI("https://api.openai.com/v1/chat/completions")
  http = Net::HTTP.new(uri.host, uri.port)
  http.use_ssl = true

  request = Net::HTTP::Post.new(uri)
  request["Content-Type"] = "application/json"
  request["Authorization"] = "Bearer #{secret_key}"
  request.body = {
    model: "gpt-4o-mini",
    messages: [
      { role: "system", content: prompt },
      { role: "user", content: diff },
    ],
    temperature: 0.2,
  }.to_json

  response = http.request(request)
  unless response.is_a?(Net::HTTPSuccess)
    raise "OpenAI API request failed (#{response.code}): #{response.body}"
  end

  body = JSON.parse(response.body)
  message = body.dig("choices", 0, "message", "content")
  raise "OpenAI response did not include a message" if message.nil? || message.strip.empty?

  message.strip
end

diff_and_prompt = "#{diff}\n======================\n#{prompt}"
openai_secret_key = load_env_value("OPENAI_SECRET_KEY")
approval_flag = load_env_value("APPROVE_AI_REQUEST")

begin
  if openai_secret_key && consent_granted?(approval_flag)
    ai_response = fetch_ai_summary(openai_secret_key, prompt, diff)
    copy_to_clipboard(ai_response)
    puts wrap_in_color("ü§ñ The recommended Git Commit / Pull Request Message has been copied to your clipboard")
  else
    copy_to_clipboard(diff_and_prompt)
    puts wrap_in_color("üìã The git diff and prompt have been copied to your clipboard")
  end
rescue => e
  warn wrap_in_color("‚ö†Ô∏è #{e.message}. Falling back to diff and prompt.", "failure")
  copy_to_clipboard(diff_and_prompt)
  puts wrap_in_color("üìã The git diff and prompt have been copied to your clipboard")
end
